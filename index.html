<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【共同編集】案件スケジュール管理シート</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .table-cell {
            padding: 10px 12px;
            border: 1px solid #e2e8f0; /* slate-200 */
            vertical-align: top;
            min-height: 60px;
            transition: background-color 0.2s;
        }
        .table-cell[contenteditable="true"]:focus {
            outline: 2px solid #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
            z-index: 10;
            position: relative;
        }
        .header-cell {
            background-color: #f8fafc; /* slate-50 */
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 20;
            text-align: left;
            padding: 12px;
        }
        .header-cell .project-title { font-size: 0.95rem; color: #1e293b; }
        .header-cell .project-details { font-size: 0.8rem; font-weight: 400; color: #64748b; }
        .saturday { background-color: #f0f9ff; /* sky-50 */ }
        .sunday, .holiday { background-color: #fef2f2; /* red-50 */ }
        strong { font-weight: 700; color: #1e293b; /* slate-800 */ }
        .today { border-left: 3px solid #ef4444; /* red-500 */ }
        #status {
            transition: opacity 0.5s;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white shadow-lg rounded-xl overflow-hidden">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">【共同編集】案件スケジュール管理シート</h1>
                    <p class="mt-2 text-gray-600">変更はリアルタイムで全員に共有され、自動保存されます。</p>
                </div>
                <div id="status" class="text-sm text-gray-500 opacity-0">保存中...</div>
            </div>
            <div class="overflow-x-auto">
                <table id="schedule-table" class="min-w-full border-collapse text-sm">
                    <thead class="text-left text-gray-700">
                        <tr>
                            <th class="table-cell header-cell w-24">日付</th>
                            <th class="table-cell header-cell w-16">曜日</th>
                            <th class="table-cell header-cell">
                                <div class="project-title">未来チラシ</div>
                                <div class="project-details">A4ペラ / 仮16万部</div>
                            </th>
                            <th class="table-cell header-cell">
                                <div class="project-title">勧奨チラシ</div>
                                <div class="project-details">A4ぺら / 仮7万部</div>
                            </th>
                            <th class="table-cell header-cell">
                                <div class="project-title">フォトコン作品集</div>
                                <div class="project-details">16P / 仮10万部</div>
                            </th>
                            <th class="table-cell header-cell">備考</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body" class="bg-white">
                        <tr><td colspan="6" class="p-8 text-center text-gray-500">データを読み込んでいます...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <footer class="text-center mt-6 text-xs text-gray-500">
            <p>UserID: <span id="userId"></span></p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, setDoc, onSnapshot, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const scheduleCollectionPath = `artifacts/${appId}/public/data/schedule`;
        const scheduleCol = collection(db, scheduleCollectionPath);

        const statusDiv = document.getElementById('status');
        const userIdSpan = document.getElementById('userId');

        // --- Initial Data (only used if DB is empty) ---
        const initialScheduleData = [
            { order: 0, date: "6月20日", dayOfWeek: "金", taskA: "", taskB: "", taskC: "写真プリント/準備", remarks: "**本日**" },
            { order: 1, date: "6月21日", dayOfWeek: "土", taskA: "", taskB: "", taskC: "", remarks: "休日" },
            { order: 2, date: "6月22日", dayOfWeek: "日", taskA: "", taskB: "", taskC: "", remarks: "休日" },
            { order: 3, date: "6月23日", dayOfWeek: "月", taskA: "", taskB: "", taskC: "画像補正", remarks: "" },
            { order: 4, date: "6月24日", dayOfWeek: "火", taskA: "", taskB: "", taskC: "画像補正", remarks: "" },
            { order: 5, date: "6月25日", dayOfWeek: "水", taskA: "**データ入稿**", taskB: "", taskC: "初校色校正", remarks: "" },
            { order: 6, date: "6月26日", dayOfWeek: "木", taskA: "画像補正", taskB: "", taskC: "**初校提出**", remarks: "" },
            { order: 7, date: "6月27日", dayOfWeek: "金", taskA: "色校正", taskB: "", taskC: "お戻し", remarks: "" },
            { order: 8, date: "6月28日", dayOfWeek: "土", taskA: "", taskB: "", taskC: "", remarks: "休日" },
            { order: 9, date: "6月29日", dayOfWeek: "日", taskA: "", taskB: "", taskC: "", remarks: "休日" },
            { order: 10, date: "6月30日", dayOfWeek: "月", taskA: "色校提出", taskB: "", taskC: "修正作業", remarks: "" },
            { order: 11, date: "7月1日", dayOfWeek: "火", taskA: "", taskB: "", taskC: "再色校正", remarks: "" },
            { order: 12, date: "7月2日", dayOfWeek: "水", taskA: "**校了**", taskB: "", taskC: "再校提出", remarks: "" },
            { order: 13, date: "7月3日", dayOfWeek: "木", taskA: "刷版", taskB: "", taskC: "", remarks: "" },
            { order: 14, date: "7月4日", dayOfWeek: "金", taskA: "印刷", taskB: "**データ入稿**", taskC: "**校了**", remarks: "" },
            { order: 15, date: "7月5日", dayOfWeek: "土", taskA: "", taskB: "", taskC: "", remarks: "休日" },
            { order: 16, date: "7月6日", dayOfWeek: "日", taskA: "", taskB: "", taskC: "", remarks: "休日" },
            { order: 17, date: "7月7日", dayOfWeek: "月", taskA: "加工", taskB: "画像補正", taskC: "印刷", remarks: "" },
            { order: 18, date: "7月8日", dayOfWeek: "火", taskA: "移動", taskB: "色校正", taskC: "印刷", remarks: "" },
            { order: 19, date: "7月9日", dayOfWeek: "水", taskA: "梱包 ブレイブ", taskB: "色校正提出", taskC: "印刷", remarks: "" },
            { order: 20, date: "7月10日", dayOfWeek: "木", taskA: "梱包", taskB: "", taskC: "印刷", remarks: "" },
            { order: 21, date: "7月11日", dayOfWeek: "金", taskA: "梱包", taskB: "**校了**", taskC: "印刷", remarks: "" },
            { order: 22, date: "7月12日", dayOfWeek: "土", taskA: "", taskB: "", taskC: "", remarks: "休日" },
            { order: 23, date: "7月13日", dayOfWeek: "日", taskA: "", taskB: "", taskC: "", remarks: "休日" },
            { order: 24, date: "7月14日", dayOfWeek: "月", taskA: "梱包", taskB: "刷版", taskC: "加工", remarks: "中村・融和" },
            { order: 25, date: "7月15日", dayOfWeek: "火", taskA: "梱包", taskB: "印刷", taskC: "加工", remarks: "中村・融和" },
            { order: 26, date: "7月16日", dayOfWeek: "水", taskA: "梱包", taskB: "印刷", taskC: "加工", remarks: "中村・融和" },
            { order: 27, date: "7月17日", dayOfWeek: "木", taskA: "**納品（MYO）**", taskB: "加工 中町", taskC: "加工", remarks: "中村・融和" },
            { order: 28, date: "7月18日", dayOfWeek: "金", taskA: "", taskB: "加工 中町", taskC: "加工", remarks: "中村・融和" },
            { order: 29, date: "7月19日", dayOfWeek: "土", taskA: "", taskB: "", taskC: "移動 ブレイブ", remarks: "休日" },
            { order: 30, date: "7月20日", dayOfWeek: "日", taskA: "", taskB: "", taskC: "", remarks: "休日" },
            { order: 31, date: "7月21日", dayOfWeek: "月", taskA: "", taskB: "", taskC: "", remarks: "**祝日(海の日)**" },
            { order: 32, date: "7月22日", dayOfWeek: "火", taskA: "", taskB: "**納品日（gf.k）他**", taskC: "梱包", remarks: "ブレイブ" },
            { order: 33, date: "7月23日", dayOfWeek: "水", taskA: "", taskB: "", taskC: "梱包", remarks: "" },
            { order: 34, date: "7月24日", dayOfWeek: "木", taskA: "", taskB: "", taskC: "梱包", remarks: "" },
            { order: 35, date: "7月25日", dayOfWeek: "金", taskA: "", taskB: "", taskC: "梱包", remarks: "" },
            { order: 36, date: "7月26日", dayOfWeek: "土", taskA: "", taskB: "", taskC: "", remarks: "休日" },
            { order: 37, date: "7月27日", dayOfWeek: "日", taskA: "", taskB: "", taskC: "", remarks: "休日" },
            { order: 38, date: "7月28日", dayOfWeek: "月", taskA: "", taskB: "", taskC: "**納品日（MYO）**", remarks: "" }
        ];

        // --- Authentication ---
        async function signIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                const user = auth.currentUser;
                if (user && userIdSpan) {
                    userIdSpan.textContent = user.uid;
                }
                return user;
            } catch (error) {
                console.error("Authentication Error:", error);
                if (userIdSpan) userIdSpan.textContent = "Error";
                return null;
            }
        }

        // --- UI Rendering ---
        function formatCellContent(text) {
            if (!text) return '';
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        function buildTable(data) {
            const tableBody = document.getElementById('schedule-body');
            if (!tableBody) return;
            tableBody.innerHTML = ''; 

            // Sort data by the 'order' field before rendering
            const sortedData = data.sort((a, b) => a.order - b.order);

            sortedData.forEach((rowData) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.dataset.id = rowData.id;

                if (rowData.dayOfWeek === '土') row.classList.add('saturday');
                else if (rowData.dayOfWeek === '日' || (rowData.remarks && rowData.remarks.includes('祝日'))) row.classList.add('sunday');
                if (rowData.remarks && rowData.remarks.includes('本日')) row.classList.add('today');

                row.innerHTML = `
                    <td class="table-cell font-medium text-gray-900">${rowData.date}</td>
                    <td class="table-cell">${rowData.dayOfWeek}</td>
                    <td class="table-cell" contenteditable="true" data-field="taskA">${formatCellContent(rowData.taskA)}</td>
                    <td class="table-cell" contenteditable="true" data-field="taskB">${formatCellContent(rowData.taskB)}</td>
                    <td class="table-cell" contenteditable="true" data-field="taskC">${formatCellContent(rowData.taskC)}</td>
                    <td class="table-cell" contenteditable="true" data-field="remarks">${formatCellContent(rowData.remarks)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- Firestore Interaction ---
        async function initializeData() {
            const snapshot = await getDocs(scheduleCol);
            if (snapshot.empty) {
                console.log("No data found in Firestore. Initializing with local data.");
                const batch = writeBatch(db);
                initialScheduleData.forEach((rowData) => {
                    const docRef = doc(scheduleCol); // Auto-generate ID
                    batch.set(docRef, rowData);
                });
                await batch.commit();
            }
        }

        async function updateCell(docId, field, value) {
            statusDiv.style.opacity = '1';
            try {
                const docRef = doc(db, scheduleCollectionPath, docId);
                await setDoc(docRef, { [field]: value }, { merge: true });
            } catch (error) {
                console.error("Error updating document: ", error);
                statusDiv.textContent = "Error!";
            } finally {
                setTimeout(() => {
                    statusDiv.style.opacity = '0';
                    statusDiv.textContent = '保存中...';
                }, 1500);
            }
        }

        // --- Event Listeners ---
        document.getElementById('schedule-body').addEventListener('blur', (event) => {
            const cell = event.target;
            if (cell.hasAttribute('contenteditable')) {
                const docId = cell.parentElement.dataset.id;
                const field = cell.dataset.field;
                const value = cell.textContent; // Use textContent to get plain text
                updateCell(docId, field, value);
            }
        }, true);
        
        // --- Main Execution ---
        async function main() {
            console.log("Starting application...");
            const user = await signIn();
            if (!user) {
                console.error("Failed to sign in. App cannot connect to database.");
                document.getElementById('schedule-body').innerHTML = '<tr><td colspan="6" class="p-8 text-center text-red-500">データベースへの接続に失敗しました。</td></tr>';
                return;
            }
            console.log("User signed in:", user.uid);
            
            await initializeData();
            console.log("Data initialized.");

            // Removed orderBy from the query to prevent index-related errors
            const q = query(scheduleCol); 
            onSnapshot(q, (snapshot) => {
                console.log("Received snapshot with", snapshot.size, "documents.");
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (data.length === 0) {
                     console.log("Snapshot is empty, something might be wrong.");
                     document.getElementById('schedule-body').innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500">データがありません。</td></tr>';
                } else {
                    buildTable(data);
                }
            }, (error) => {
                console.error("Snapshot Error: ", error);
                document.getElementById('schedule-body').innerHTML = `<tr><td colspan="6" class="p-8 text-center text-red-500">データの読み込み中にエラーが発生しました: ${error.message}</td></tr>`;
            });
        }
        
        main();

    </script>
</body>
</html>
